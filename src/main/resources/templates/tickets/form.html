<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section}, ${ticket.id}!=null?'Edit Ticket':'New Ticket', 'tickets')}">
<section>
    <div class="card shadow-sm">
        <div class="card-body">
            <form th:action="${ticket.id} != null ? '/tickets/' + ${ticket.id} : '/tickets'" method="post" th:object="${ticket}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" th:value="*{title}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Reporter</label>
                        <input type="text" class="form-control" name="reporterName" th:value="*{reporterName}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <input type="hidden" name="description" th:value="*{description}" id="descriptionInput">
                        <div id="editor" class="form-control" style="height: 220px; overflow:auto;"></div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Station</label>
                        <select class="form-select select2" name="station.id" required>
                            <option th:each="s : ${stations}" th:value="${s.id}" th:selected="*{station}!=null ? ${s.id}==*{station.id} : false" th:text="${s.name}"></option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Category</label>
                        <div class="d-flex gap-2">
                            <select class="form-select select2 flex-grow-1" name="issueCategory.id" id="categorySelect" required>
                                <option th:each="c : ${categories}" th:value="${c.id}" th:selected="*{issueCategory}!=null ? ${c.id}==*{issueCategory.id} : false" th:text="${c.name}"></option>
                            </select>
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal"><i class="bi bi-plus-lg"></i></button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" required>
                            <option th:each="st : ${statuses}" th:value="${st}" th:selected="${st}==*{status}" th:text="${st}"></option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Raising Date Time</label>
                        <input type="datetime-local" class="form-control" name="raisingDateTime"
                               th:value="${#temporals.format(ticket.raisingDateTime, 'yyyy-MM-dd''T''HH:mm')}">
                    </div>
                </div>
                <div class="mt-4 d-flex gap-2">
                    <a href="/tickets" class="btn btn-outline-secondary">Back</a>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</section>
</html>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var quill = new Quill('#editor', { theme: 'snow' });
        var hiddenInput = document.getElementById('descriptionInput');
        if (hiddenInput && hiddenInput.value) {
            quill.root.innerHTML = hiddenInput.value;
        }
        var form = document.querySelector('form');
        form.addEventListener('submit', function () {
            hiddenInput.value = quill.root.innerHTML;
        });
        // Initialize Select2
        $('.select2').select2({ width: '100%' });

        // Add Category modal submit
        $('#saveNewCategory').on('click', function(){
            const name = $('#newCategoryName').val();
            const description = $('#newCategoryDescription').val();
            if(!name) return;
            $.ajax({
                url: '/categories/ajax',
                method: 'POST',
                data: { name: name, description: description },
                success: function(res){
                    const id = res.id;
                    const nm = res.name;
                    const newOption = new Option(nm, id, true, true);
                    $('#categorySelect').append(newOption).trigger('change');
                    $('#addCategoryModal').modal('hide');
                }
            });
        });
    });
    </script>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" id="newCategoryName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" id="newCategoryDescription" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveNewCategory" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>


