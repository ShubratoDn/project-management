<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section}, 'Tickets', 'tickets')}">
<section>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Tickets</h2>
        <a href="/tickets/new" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> New Ticket</a>
    </div>

    <form class="card shadow-sm mb-3 p-3" method="get" action="/tickets">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" name="q" class="form-control" th:value="${q}" placeholder="Title or description">
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select select2" name="status" multiple="multiple" data-placeholder="Any">
                    <option th:each="s : ${statuses}" th:value="${s}" th:selected="${statusFilter != null and #lists.contains(statusFilter, s)}" th:text="${s}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Station</label>
                <select class="form-select select2" name="stationId" multiple="multiple" data-placeholder="Any">
                    <option th:each="s : ${stations}" th:value="${s.id}" th:selected="${stationId != null and #lists.contains(stationId, s.id)}" th:text="${s.name}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Category</label>
                <select class="form-select select2" name="categoryId" multiple="multiple" data-placeholder="Any">
                    <option th:each="c : ${categories}" th:value="${c.id}" th:selected="${categoryId != null and #lists.contains(categoryId, c.id)}" th:text="${c.name}"></option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label">Order By</label>
                <select class="form-select" name="orderBy">
                    <option value="raisingDateTime" th:selected="${orderBy}=='raisingDateTime'">Raised</option>
                    <option value="id" th:selected="${orderBy}=='id'">ID</option>
                    <option value="title" th:selected="${orderBy}=='title'">Title</option>
                    <option value="status" th:selected="${orderBy}=='status'">Status</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label">Dir</label>
                <select class="form-select" name="orderDir">
                    <option value="desc" th:selected="${orderDir}=='desc'">Desc</option>
                    <option value="asc" th:selected="${orderDir}=='asc'">Asc</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label">Rows</label>
                <select class="form-select" name="size">
                    <option value="10" th:selected="${size}==10">10</option>
                    <option value="20" th:selected="${size}==20">20</option>
                    <option value="50" th:selected="${size}==50">50</option>
                    <option value="100" th:selected="${size}==100">100</option>
                </select>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary" type="submit">Filter</button>
            <a class="btn btn-outline-secondary" href="/tickets">Reset</a>
        </div>
    </form>

    <div id="ticket-table-container" th:fragment="ticketTableFragment">
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Station</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Raised</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="t : ${ticketPage}">
                        <td th:text="${t.id}"></td>
                        <td th:text="${t.title}"></td>
                        <td th:text="${t.station.name}"></td>
                        <td th:text="${t.issueCategory.name}"></td>
                        <td>
                            <span class="badge rounded-pill bg-secondary status-badge" th:data-id="${t.id}" th:text="${t.status}" style="cursor: pointer; user-select: none;" title="Double-click to change"></span>
                        </td>
                        <td th:text="${#temporals.format(t.raisingDateTime, 'dd-MMM-yyyy hh:mm a')}"></td>
                        <td class="text-end">
                            <a th:href="@{'/tickets/' + ${t.id} + '/edit'}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></a>
                            <form th:action="@{'/tickets/' + ${t.id} + '/delete'}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete ticket?')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${ticketPage.totalElements}==0">
                        <td colspan="7" class="text-center text-muted">No tickets found.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <div>
                    <span th:text="'Page ' + ${ticketPage.number + 1} + ' of ' + ${ticketPage.totalPages}"></span>
                </div>
                <nav>
                    <ul class="pagination mb-0">
                        <li class="page-item" th:classappend="${ticketPage.first} ? 'disabled'">
                            <a class="page-link page-link-ajax" th:href="@{/tickets(page=${ticketPage.number - 1}, size=${ticketPage.size}, q=${q}, status=${statusFilter}, stationId=${stationId}, categoryId=${categoryId})}">Prev</a>
                        </li>
                        <li class="page-item disabled"><a class="page-link" href="#" th:text="${ticketPage.number + 1}"></a></li>
                        <li class="page-item" th:classappend="${ticketPage.last} ? 'disabled'">
                            <a class="page-link page-link-ajax" th:href="@{/tickets(page=${ticketPage.number + 1}, size=${ticketPage.size}, q=${q}, status=${statusFilter}, stationId=${stationId}, categoryId=${categoryId})}">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <select id="statusSelect" class="form-select">
                        <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>
</section>
</html>

<script th:inline="javascript">
    (function(){
    const filters = ['q','status','stationId','categoryId','orderBy','orderDir','size'];

        // Persist filters in localStorage and auto-submit on change/typing
        function applySavedFilters(){
            try{
                const saved = JSON.parse(localStorage.getItem('ticketFilters')||'{}');
                filters.forEach(k=>{
                    const el = document.querySelector('[name="'+k+'"]');
                    if(el && saved[k]!==undefined && saved[k]!==null && saved[k]!=='' ){
                        if($(el).hasClass('select2')) {
                            let val = saved[k];
                            if(typeof val === 'string' && val.startsWith('[')) val = JSON.parse(val);
                            $(el).val(val).trigger('change');
                        } else {
                            el.value = saved[k];
                        }
                    }
                });
            }catch(e){}
        }
        function saveFilters(){
            const data = {};
            filters.forEach(k=>{
                const el = document.querySelector('[name="'+k+'"]');
                if(el) {
                    if($(el).hasClass('select2')) {
                        data[k] = $(el).val();
                    } else {
                        data[k] = el.value;
                    }
                }
            });
            localStorage.setItem('ticketFilters', JSON.stringify(data));
        }
        function autoFilter(){
            saveFilters();
            const form = document.querySelector('form[action="/tickets"]') || document.querySelector('form[method="get"]');
            if(!form) return;
            const data = $(form).serialize();
            $.get('/tickets/fragment', data, function(html){
                $('#ticket-table-container').replaceWith(html);
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            applySavedFilters();
            // If any filter is set, trigger AJAX filter to load correct data
            const saved = JSON.parse(localStorage.getItem('ticketFilters')||'{}');
            let hasFilter = false;
            filters.forEach(k=>{
                if(saved[k] && saved[k] !== '') hasFilter = true;
            });
            if(hasFilter) {
                setTimeout(autoFilter, 10); // let the fields update first
            }
            const q = document.querySelector('[name="q"]');
            if(q){ q.addEventListener('keyup', function(){ clearTimeout(q._t); q._t = setTimeout(autoFilter, 300); }); }
            ['status','stationId','categoryId','orderBy','orderDir','size'].forEach(k=>{
                const el = document.querySelector('[name="'+k+'"]');
                if(el){
                    if($(el).hasClass('select2')) {
                        $(el).on('change', autoFilter);
                    } else {
                        el.addEventListener('change', autoFilter);
                    }
                }
            });

            // Initialize select2
            $('.select2').select2({
                width: '100%',
                allowClear: true,
                placeholder: function(){ return $(this).data('placeholder') || 'Select'; }
            });

            // Status modal logic with AJAX
            let currentId = null;
            const modalEl = document.getElementById('statusModal');
            const modal = new bootstrap.Modal(modalEl);
            const statusSelect = document.getElementById('statusSelect');
            const saveBtn = document.getElementById('saveStatusBtn');

            $(document).on('dblclick', '.status-badge', function(){
                currentId = this.getAttribute('data-id');
                const currentText = this.textContent.trim();
                if(statusSelect){
                    for (const opt of statusSelect.options){
                        opt.selected = (opt.value === currentText);
                    }
                }
                modal.show();
            });

            saveBtn && saveBtn.addEventListener('click', function(){
                if(!currentId) return;
                const newStatus = statusSelect.value;
                $.post('/tickets/' + currentId + '/status', { status: newStatus, ajax: true })
                 .done(function(){
                    const badge = document.querySelector('.status-badge[data-id="'+currentId+'"]');
                    if(badge){ badge.textContent = newStatus; }
                    modal.hide();
                 });
            });

            // AJAX pagination
            $(document).on('click', '.page-link-ajax', function(e){
                e.preventDefault();
                const url = $(this).attr('href').replace('/tickets', '/tickets/fragment');
                $.get(url, function(html){
                    $('#ticket-table-container').replaceWith(html);
                });
            });
        });
    })();
    </script>


