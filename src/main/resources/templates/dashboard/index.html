<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::section}, 'Dashboard', 'dashboard')}">
<section>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Dashboard</h2>
        <div class="d-flex gap-2">
            <input type="date" id="fromDate" class="form-control">
            <input type="date" id="toDate" class="form-control">
            <select id="granularity" class="form-select">
                <option value="day">Daily</option>
                <option value="week">Weekly</option>
                <option value="month">Monthly</option>
                <option value="year">Yearly</option>
            </select>
            <select id="stationFilter" class="form-select">
                <option value="">All Stations</option>
                <option th:each="s : ${stations}" th:value="${s.id}" th:text="${s.name}"></option>
            </select>
            <select id="categoryFilter" class="form-select">
                <option value="">All Categories</option>
                <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
            </select>
        </div>
    </div>


    <div class="row g-3" id="supportSummaryRow">
        <div class="col-lg-2 col-md-4 col-6 mb-2">
            <div class="card shadow-sm border-primary text-primary bg-light h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Total Supports</h6>
                    <div class="display-6 fw-bold" id="totalSupports">0</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-2">
            <div class="card shadow-sm border-info text-info bg-light h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Open</h6>
                    <div class="display-6 fw-bold" id="statusOpen">0</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-2">
            <div class="card shadow-sm border-warning text-warning bg-light h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">In Progress</h6>
                    <div class="display-6 fw-bold" id="statusInProgress">0</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-2">
            <div class="card shadow-sm border-secondary text-secondary bg-light h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">On Hold</h6>
                    <div class="display-6 fw-bold" id="statusOnHold">0</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-2">
            <div class="card shadow-sm border-success text-success bg-light h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Resolved</h6>
                    <div class="display-6 fw-bold" id="statusResolved">0</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-2">
            <div class="card shadow-sm border-dark text-dark bg-light h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Closed</h6>
                    <div class="display-6 fw-bold" id="statusClosed">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header">Supports over time</div>
                <div class="card-body"><canvas id="byDateChart" height="140"></canvas></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header">Station-wise supports</div>
                <div class="card-body"><canvas id="byStationChart" height="140"></canvas></div>
            </div>
        </div>
    </div>
    <div class="row g-3 mt-1">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header">Category-wise supports</div>
                <div class="card-body"><canvas id="byCategoryChart" height="140"></canvas></div>
            </div>
        </div>
    </div>
</section>
</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    (function(){
        const lsKey = 'dashFilters';
        function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
        function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d; }
        function fmt(d){ return d.toISOString().slice(0,10); }
        function save(){ localStorage.setItem(lsKey, JSON.stringify(getFilters())); }
        function load(){ try{ return JSON.parse(localStorage.getItem(lsKey)||'{}'); }catch(e){ return {}; } }
        function getFilters(){ return {
            from: document.getElementById('fromDate').value,
            to: document.getElementById('toDate').value,
            granularity: document.getElementById('granularity').value,
            stationId: document.getElementById('stationFilter').value,
            categoryId: document.getElementById('categoryFilter').value
        }; }
        function setFilters(f){
            document.getElementById('fromDate').value = f.from||fmt(daysAgo(30));
            document.getElementById('toDate').value = f.to||fmt(today());
            if(f.granularity) document.getElementById('granularity').value = f.granularity;
            if(f.stationId!==undefined) document.getElementById('stationFilter').value = f.stationId;
            if(f.categoryId!==undefined) document.getElementById('categoryFilter').value = f.categoryId;
        }

        let byDateChart, byStationChart, byCategoryChart;
        function ensureChart(ctx, cfg){ if(ctx._chart){ ctx._chart.destroy(); } ctx._chart = new Chart(ctx, cfg); return ctx._chart; }

        function refresh(){
            const f = getFilters();
            save();
            // Total & Status-wise
            $.get('/dashboard/api/overview', f, function(res){
                $('#totalSupports').text(res.total);
                const sc = res.statusCounts || {};
                $('#statusOpen').text(sc.OPEN || 0);
                $('#statusInProgress').text(sc.IN_PROGRESS || 0);
                $('#statusOnHold').text(sc.ON_HOLD || 0);
                $('#statusResolved').text(sc.RESOLVED || 0);
                $('#statusClosed').text(sc.CLOSED || 0);
            });
            // By Date
            $.get('/dashboard/api/by-date', f, function(res){
                const labels = res.rows.map(r=>r.bucket);
                const data = res.rows.map(r=>r.cnt);
                const ctx = document.getElementById('byDateChart');
                ensureChart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Supports', data, borderColor:'#0d6efd', fill:false }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } } });
            });
            // By Station
            $.get('/dashboard/api/by-station', f, function(res){
                let labels = res.rows.map(r=>r.label);
                let data = res.rows.map(r=>r.cnt);
                const ctx = document.getElementById('byStationChart');
                // If a specific station is selected, show only that station's data
                if (f.stationId && f.stationId !== "") {
                    // Try to find the selected station in the result
                    const idx = labels.findIndex((l, i) => String(res.rows[i].stationId || res.rows[i].id || "") === f.stationId);
                    if (idx !== -1) {
                        labels = [labels[idx]];
                        data = [data[idx]];
                    } else if (labels.length > 0) {
                        // fallback: just show the first if not found
                        labels = [labels[0]];
                        data = [data[0]];
                    }
                }
                ensureChart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Supports', data, backgroundColor:'#20c997' }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } } });
            });
            // By Category
            $.get('/dashboard/api/by-category', f, function(res){
                const labels = res.rows.map(r=>r.label);
                const data = res.rows.map(r=>r.cnt);
                const ctx = document.getElementById('byCategoryChart');
                ensureChart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:['#0dcaf0','#6f42c1','#fd7e14','#dc3545','#198754','#0d6efd','#20c997'] }] }, options:{ responsive:true } });
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            setFilters(load());
            ['fromDate','toDate','granularity','stationFilter','categoryFilter'].forEach(id=>{
                document.getElementById(id).addEventListener('change', refresh);
            });
            refresh();
        });
    })();
</script>

